name: Deploy Telegram Bot

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # Останавливать скрипт при любой ошибке
            
            # Переход в директорию проекта
            PROJECT_PATH="${{ secrets.PROJECT_PATH }}"
            mkdir -p $PROJECT_PATH
            cd $PROJECT_PATH

            # Сохранение .env файла
            echo "BOT_API_KEY=${{ secrets.BOT_API_TOKEN }}" > .env
            echo "LOG_LEVEL=INFO" >> .env

            # Клонирование или обновление кода
            if [ -d .git ]; then
              git pull origin main
            else
              git clone https://github.com/${{ github.repository }} .
            fi

            # Сборка Docker образа
            docker build -t telegram-bot:latest .

            # Остановка и удаление старого контейнера
            docker stop telegram-bot-container 2>/dev/null || true
            docker rm telegram-bot-container 2>/dev/null || true

            # Запуск нового контейнера
            docker run -d \
              --name telegram-bot-container \
              --restart unless-stopped \
              --env-file .env \
              telegram-bot:latest

            # Проверка что контейнер жив (минималистично, но надежно)
            echo "⏳ Проверка контейнера..."
            sleep 3
            docker ps --filter "name=telegram-bot-container" --filter "status=running" --format "table {{.Names}}\t{{.Status}}"
            
            # Если контейнер не запущен - покажем логи и упадем с ошибкой
            docker ps | grep telegram-bot-container || (echo "❌ Контейнер не запущен!" && docker logs telegram-bot-container && exit 1)

            # Очистка старых образов
            docker image prune -f
            
            echo "✅ Деплой завершен!"