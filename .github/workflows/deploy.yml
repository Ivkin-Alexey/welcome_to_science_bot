name: Deploy Telegram Bot

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
            
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π Telegram –±–æ—Ç–∞..."
            
            # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            PROJECT_PATH="${{ secrets.PROJECT_PATH }}"
            echo "üìÅ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $PROJECT_PATH"
            mkdir -p $PROJECT_PATH
            cd $PROJECT_PATH

            # –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
            echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
            if [ -d .git ]; then
              git pull origin main
              echo "‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ git pull"
            else
              git clone https://github.com/${{ github.repository }} .
              echo "‚úÖ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω"
            fi

            # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (docker-compose profile prod)
            echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
            docker compose --profile prod down 2>/dev/null || true
            echo "‚úÖ –°—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

            # –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ docker-compose —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏–∑ GitHub Secrets
            echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —á–µ—Ä–µ–∑ docker compose..."
            BOT_API_TOKEN="${{ secrets.BOT_API_TOKEN }}" \
            LOG_LEVEL="INFO" \
            docker compose --profile prod up -d --build
            
            echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É..."

            # ========== –ü–†–û–í–ï–†–ö–ê –°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–ò ==========
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞..."
            
            # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∏
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ 15 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏..."
            sleep 15

            # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–µ–π—á–∞—Å
            if [ ! "$(docker ps -q -f name=welcome_to_science_bot_prod)" ]; then
              echo "‚ùå –û–®–ò–ë–ö–ê: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
              echo ""
              echo "üìã –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
              docker ps -a -f name=welcome_to_science_bot_prod
              echo ""
              echo "üìã –õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
              docker logs welcome_to_science_bot_prod
              exit 1
            fi
            echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç"

            # –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤
            RESTART_COUNT=$(docker inspect welcome_to_science_bot_prod --format='{{.RestartCount}}')
            if [ "$RESTART_COUNT" -gt 0 ]; then
              echo "‚ö†Ô∏è –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–ª—Å—è $RESTART_COUNT —Ä–∞–∑(–∞)"
              if [ "$RESTART_COUNT" -gt 2 ]; then
                echo "‚ùå –û–®–ò–ë–ö–ê: –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ ($RESTART_COUNT)"
                echo ""
                echo "üìã –õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
                docker logs welcome_to_science_bot_prod --tail 50
                exit 1
              fi
            else
              echo "‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ –Ω–µ –±—ã–ª–æ"
            fi

            # –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
            echo "üìã –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫..."
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –æ—à–∏–±–∫—É —Å —Ç–æ–∫–µ–Ω–æ–º
            if docker logs welcome_to_science_bot_prod 2>&1 | grep -q "BOT_API_TOKEN is not defined"; then
              echo "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: BOT_API_TOKEN –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä!"
              echo ""
              echo "üìã –õ–æ–≥–∏:"
              docker logs welcome_to_science_bot_prod --tail 20
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
            ERROR_LOGS=$(docker logs welcome_to_science_bot_prod 2>&1 | grep -i "error\|exception\|fail" | head -20)
            if [ ! -z "$ERROR_LOGS" ]; then
              echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö (–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç):"
              echo "$ERROR_LOGS"
            else
              echo "‚úÖ –û—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
            fi

            # –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å Node.js –∂–∏–≤
            if docker exec welcome_to_science_bot_prod ps aux 2>/dev/null | grep -q node; then
              echo "‚úÖ Node.js –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç–∞–µ—Ç"
            else
              echo "‚ùå –û–®–ò–ë–ö–ê: Node.js –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞!"
              echo ""
              echo "üìã –ü—Ä–æ—Ü–µ—Å—Å—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:"
              docker exec welcome_to_science_bot_prod ps aux 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å ps aux"
              echo ""
              echo "üìã –õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
              docker logs welcome_to_science_bot_prod --tail 30
              exit 1
            fi

            # –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            if docker exec welcome_to_science_bot_prod env | grep -q "BOT_API_TOKEN"; then
              echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è BOT_API_TOKEN –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ"
            else
              echo "‚ùå –û–®–ò–ë–ö–ê: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è BOT_API_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞!"
              echo ""
              echo "üìã –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:"
              docker exec welcome_to_science_bot_prod env | grep -E "BOT|NODE" || echo "–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
              exit 1
            fi

            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –¥–∞–µ–º –µ—â–µ –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —É–ø–∞–ª
            echo "‚è≥ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ (5 —Å–µ–∫—É–Ω–¥)..."
            sleep 5
            
            if [ ! "$(docker ps -q -f name=welcome_to_science_bot_prod)" ]; then
              echo "‚ùå –û–®–ò–ë–ö–ê: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–ø–∞–ª –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–æ–∫!"
              echo ""
              echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
              docker logs welcome_to_science_bot_prod --tail 50
              exit 1
            fi

            # ========== –£–°–ü–ï–®–ù–û–ï –ó–ê–í–ï–†–®–ï–ù–ò–ï ==========
            echo ""
            echo "üéâüéâüéâ –î–ï–ü–õ–û–ô –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù! üéâüéâüéâ"
            echo ""
            echo "üìä –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
            echo "   ‚Ä¢ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: welcome_to_science_bot_prod"
            echo "   ‚Ä¢ –°—Ç–∞—Ç—É—Å: $(docker inspect welcome_to_science_bot_prod --format='{{.State.Status}}')"
            echo "   ‚Ä¢ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤: $(docker inspect welcome_to_science_bot_prod --format='{{.RestartCount}}')"
            echo "   ‚Ä¢ –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: $(docker inspect welcome_to_science_bot_prod --format='{{.State.StartedAt}}' | cut -d'T' -f2 | cut -d'.' -f1)"
            echo ""
            echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
            docker logs --tail 5 welcome_to_science_bot_prod
            echo ""
            echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ!"

            # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤
            echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤..."
            docker image prune -f
            echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"