name: Deploy Telegram Bot

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Переход в директорию проекта
            PROJECT_PATH="${{ secrets.PROJECT_PATH }}"
            mkdir -p $PROJECT_PATH
            cd $PROJECT_PATH

            # Сохранение .env файла
            echo "BOT_TOKEN=${{ secrets.BOT_API_TOKEN }}" > .env
            echo "LOG_LEVEL=INFO" >> .env

            # Клонирование или обновление кода
            if [ -d .git ]; then
              git pull origin main
            else
              git clone https://github.com/${{ github.repository }} .
            fi

            # Сборка Docker образа
            docker build -t telegram-bot:latest .

            # Остановка и удаление старого контейнера (игнорируем ошибки, если контейнера нет)
            docker stop telegram-bot-container || true
            docker rm telegram-bot-container || true

            # Запуск нового контейнера
            docker run -d \
              --name telegram-bot-container \
              --restart unless-stopped \
              --env-file .env \
              telegram-bot:latest

            # Очистка старых образов (кроме только что собранного)
            docker image prune -f